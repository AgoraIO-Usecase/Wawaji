Signal_=function(n){function e(n,e,i){var t=new XMLHttpRequest,o=!1,s=setTimeout(function(){o=!0,t.abort(),i("timeout","")},e);t.open("GET",n),t.onreadystatechange=function(){4===t.readyState&&(o||(clearTimeout(s),200===t.status&&i("",t.responseText)))},t.send(null)}function i(n,e,i){var t=n.split(e,i),o=0;for(var s in t)o+=e.length+t[s].length;return t.push(n.substr(o)),t}this.vid=n,this.appid=n;var t=this,o=function(o,s){this.onLoginSuccess="",this.onLoginFailed="",this.onLogout="",this.onInviteReceived="",this.onMessageInstantReceive="",this.state="session_state_logining",this.line="",this.uid=0,this.dbg=!1;var a,l=this,r=function(){if(l.dbg){var n=[];for(var e in arguments)n.push(arguments[e]);console.log.apply(null,["Agora sig dbg :"].concat(n))}},c=[],v=function(){var n=c[Math.floor(Math.random()*c.length)];return"wss://"+(n[0].replace(/\./g,"-")+"-sig-web.agora.io")+":"+(n[1]+1)+"/"},u=function(i){e("//lbs-sig.agora.io/getaddr?vid="+n,5e3,function(n,e){n?i-1>0?u(i-1):fire_login_failed("lbs timeout"):(c=JSON.parse(e).web,h())})},h=function(){var e=v();a=new function(){var n=new WebSocket(e);n.onopen=function(e){r("on conn open");for(var i in o)n.send(JSON.stringify(o[i]))},n.onclose=function(n){t("_close",""),r("on conn close")},n.onmessage=function(n){var e=n.data,i=JSON.parse(e);i[0];t(i[0],i[1])},n.onerror=function(n){r("on conn error"),"session_state_logined"==l.state?m("conn error"):"session_state_logining"==l.state&&I("conn err")};var i={},t=function(n,e){n in i&&i[n](e)},o=[];this.on=function(n,e){i[n]=e},this.emit=function(e,i){0!=n.readyState?n.send(JSON.stringify([e,i])):o.push([e,i])},this.close=function(){n.close()}},l.socket=a;var t=0,c=function(){setTimeout(function(){"session_state_logined"==l.state&&(r("send ping",++t),a.emit("ping",t),c())},1e4)};""==l.line?(a.emit("login",{vid:n,account:o,uid:0,token:s,device:"websdk",ip:""}),a.on("login_ret",function(n){var e=n[0],i=JSON.parse(n[1]);r("login ret",e,i),e||"ok"!=i.result?l.onLoginFailed&&l.onLoginFailed(0):(l.uid=i.uid,l.line=i.line,l.state="session_state_logined",c(),B(),l.onLoginSuccess&&l.onLoginSuccess(l.uid),R())})):a.emit("line_login",{line:l.line});var u=0,h={},d={},f=function(n,e,i){h[++u]=[n,e,i],r("call ",[n,u,e]),a.emit("call2",[n,u,e])};a.on("call2-ret",function(n){var e=n[0],i=n[1],t=n[2];if(e in h){var o=h[e][2];o&&o(i,t)}});var g,_=function(n,e){return""==n},p=function(n){if(n.startsWith("msg-v2 ")){var e=i(n," ",6);if(7==e.length)return[e[1],e[4],e[6]]}return null};a.on("pong",function(n){r("recv pong")}),a.on("close",function(n){m(0),a.close()}),a.on("_close",function(n){m(0)});var m=function(n){"session_state_logined"==l.state&&l.onLogout&&l.onLogout(0),l.state="session_state_logout"},I=function(n){"session_state_logining"==l.state&&l.onLoginFailed&&l.onLoginFailed(0),l.state="session_state_logout"},y=function(n){var e=n,i=e[0],t=e[1],o=e[2];if("instant"==t&&l.onMessageInstantReceive&&l.onMessageInstantReceive(i,0,o),t.startsWith("voip_")){var s,a=JSON.parse(o),r=a.channel,c=a.peer,v=a.extra,u=a.peeruid;if("voip_invite"==t)s=new w(r,c,u,v),f("voip_invite_ack",{line:l.line,channelName:r,peer:c,extra:""});else if(!(s=d[r+c]))return;"voip_invite"==t&&l.onInviteReceived&&l.onInviteReceived(s),"voip_invite_ack"==t&&s.onInviteReceivedByPeer&&s.onInviteReceivedByPeer(v),"voip_invite_accept"==t&&s.onInviteAcceptedByPeer&&s.onInviteAcceptedByPeer(v),"voip_invite_refuse"==t&&s.onInviteRefusedByPeer&&s.onInviteRefusedByPeer(v),"voip_invite_failed"==t&&s.onInviteFailed&&s.onInviteFailed(v),"voip_invite_bye"==t&&s.onInviteEndByPeer&&s.onInviteEndByPeer(v),"voip_invite_msg"==t&&s.onInviteMsg&&s.onInviteMsg(v)}},C=function(){return Date.now()},L=0,S=0,J=0,b=0,N=0,U=!1,R=function(){U||(U=!0,f("user_getmsg",{line:l.line,ver_clear:L,max:30},function(n,e){if(""==n){var i=JSON.parse(e);L=i.ver_clear,J=L;for(var t in i.msgs){var o=i.msgs[t][0],s=i.msgs[t][1];y(p(s)),L=o}(30==i.msgs.length||L<S)&&R(),b=C()}U=!1,N=C()}))},M=function(){N=C()},B=function(){setTimeout(function(){if("session_state_logout"!=l.state){if("session_state_logined"==l.state){var n=C();J<L&&n-N>1e3?R():n-N>=6e4&&R()}B()}},100)};a.on("notify",function(n){r("recv notify ",n),"string"==typeof n&&(n=(n=i(n," ",2)).slice(1));var e=n[0];if("channel2"==e){var t=n[1],o=n[2];if(0!=g.m_channel_msgid&&g.m_channel_msgid+1>o)return void r("ignore channel msg",t,o,g.m_channel_msgid);g.m_channel_msgid=o;var s=p(n[3]);if(s){s[0];var a=s[1],l=s[2],c=JSON.parse(l);"channel_msg"==a&&g.onMessageChannelReceive&&g.onMessageChannelReceive(c.account,c.uid,c.msg),"channel_user_join"==a&&g.onChannelUserJoined&&g.onChannelUserJoined(c.account,c.uid),"channel_user_leave"==a&&g.onChannelUserLeaved&&g.onChannelUserLeaved(c.account,c.uid),"channel_attr_update"==a&&g.onChannelAttrUpdated&&g.onChannelAttrUpdated(c.name,c.value,c.type)}}if("msg"==e&&(S=n[1],R()),"recvmsg"==e){var v=JSON.parse(n[1]),u=v[0],h=v[1];u==L+1?(y(p(h)),L=u,M()):(S=u,R())}}),l.logout=function(){f("user_logout",{line:l.line},function(n,e){m(n),a.close()})},l.messageInstantSend=function(n,e,i){f("user_sendmsg",{line:l.line,peer:n,flag:"v1:E:3600",t:"instant",content:e},function(n,e){i&&i(!_(n))})};var w=function(n,e,i){this.onInviteReceivedByPeer="",this.onInviteAcceptedByPeer="",this.onInviteRefusedByPeer="",this.onInviteFailed="",this.onInviteEndByPeer="",this.onInviteEndByMyself="",this.onInviteMsg="";var t=this;this.channelName=n,this.peer=e,this.extra=i,d[n+e]=t,this.channelInviteUser2=function(){i=i||"",f("voip_invite",{line:l.line,channelName:n,peer:e,extra:i},function(n,e){_(n)||t.onInviteFailed(n)})},this.channelInviteAccept=function(i){i=i||"",f("voip_invite_accept",{line:l.line,channelName:n,peer:e,extra:i})},this.channelInviteRefuse=function(i){i=i||"",f("voip_invite_refuse",{line:l.line,channelName:n,peer:e,extra:i})},this.channelInviteDTMF=function(i){f("voip_invite_msg",{line:l.line,channelName:n,peer:e,extra:JSON.stringify({msgtype:"dtmf",msgdata:i})})},this.channelInviteEnd=function(i){i=i||"",f("voip_invite_bye",{line:l.line,channelName:n,peer:e,extra:i}),t.onInviteEndByMyself&&t.onInviteEndByMyself("")}};l.channelInviteUser2=function(n,e,i){var t=new w(n,e,i);return t.channelInviteUser2(),t},l.channelJoin=function(n){return g=new function(){this.onChannelJoined="",this.onChannelJoinFailed="",this.onChannelLeaved="",this.onChannelUserList="",this.onChannelUserJoined="",this.onChannelUserLeaved="",this.onChannelUserList="",this.onChannelAttrUpdated="",this.onMessageChannelReceive="",this.name=n,this.state="joining",this.m_channel_msgid=0,this.messageChannelSend=function(e,i){f("channel_sendmsg",{line:l.line,name:n,msg:e},function(n,e){i&&i()})},this.channelLeave=function(e){f("channel_leave",{line:l.line,name:n},function(n,i){g.state="leaved",e?e():g.onChannelLeaved&&g.onChannelLeaved(0)})},this.channelSetAttr=function(e,i,t){f("channel_set_attr",{line:l.line,channel:n,name:e,value:i},function(n,e){t&&t()})},this.channelDelAttr=function(e,i){f("channel_del_attr",{line:l.line,channel:n,name:e},function(n,e){i&&i()})},this.channelClearAttr=function(e){f("channel_clear_attr",{line:l.line,channel:n},function(n,i){e&&e()})}},f("channel_join",{line:l.line,name:n},function(n,e){if(""==n){g.state="joined",g.onChannelJoined&&g.onChannelJoined();var i=JSON.parse(e);if(g.onChannelUserList&&g.onChannelUserList(i.list),g.onChannelAttrUpdated)for(var t in i.attrs)g.onChannelAttrUpdated("update",t,i.attrs[t])}else g.onChannelJoinFailed&&g.onChannelJoinFailed(n)}),g}};if(t.dbg_server){var d=t.dbg_server.split(":");c=[[d[0],1*d[1]]],h()}else u(3)};this.dbg=function(n,e){"dbg_server"==n&&(this.dbg_server=e)},this.login=function(n,e){return new o(n,e)}},Signal=function(n){return new Signal_(n)};
